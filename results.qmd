# Results





## Overall Crime Trends in NY State

We start by investigating the overall trend in the total number of crimes committed since 1990 in the whole of NY State. To do so, we draw two plots, the first depicting the absolute numbers, and the second one depicting the crime numbers by population.


```{r, echo=FALSE,results='hide', message=FALSE, warning=FALSE}
library(viridis)
library(sf)
library(dplyr)
library(ggplot2)
library(patchwork)
library(gifski)
library(transformr)
library(dplyr)
library(ggplot2)
library(forcats)
library(gganimate)
library(tidyverse)
library(redav)
library(RColorBrewer)
library(ggplot2)
library(gganimate)
library(viridis)
library(magick)
library(viridis)
library(patchwork)


crime_ny <- read.csv("data/Index_Crimes_by_County_and_Agency__Beginning_1990.csv")
pop_ny <- read.csv('data/Annual_Population_Estimates_for_New_York_State_and_Counties__Beginning_1970.csv')
pop_ny$FIPS.Code <- substr(pop_ny$FIPS.Code, 3, nchar(pop_ny$FIPS.Code))

pop_ny <- pop_ny[!((pop_ny$Year %in% c(1970,1980,1990,2000,2010,2020)) & 
(pop_ny$Program.Type != 'Census Base Population')),]

county_fips <- data.frame(
  FIPS = c(
    "001", "003", "005", "007", "009", "011", "013", "015", "017", "019", "021",
    "023", "025", "027", "029", "031", "033", "035", "037", "039", "041",
    "043", "045", "047", "049", "051", "053", "055", "057", "059", "061",
    "063", "065", "067", "069", "071", "073", "075", "077", "079", "081",
    "083", "085", "087", "089", "089", "091", "093", "095", "097", "099", "101",
    "103", "105", "107", "109", "111", "113", "115", "117", "119", "121", "123"
  ),
  Name = c(
    "Albany", "Allegany", "Bronx", "Broome", "Cattaraugus", "Cayuga", "Chautauqua",
    "Chemung", "Chenango", "Clinton", "Columbia", "Cortland", "Delaware",
    "Dutchess", "Erie", "Essex", "Franklin", "Fulton", "Genesee", "Greene",
    "Hamilton", "Herkimer", "Jefferson", "Kings", "Lewis", "Livingston",
    "Madison", "Monroe", "Montgomery", "Nassau", "New York", "Niagara",
    "Oneida", "Onondaga", "Ontario", "Orange", "Orleans", "Oswego",
    "Otsego", "Putnam", "Queens", "Rensselaer", "Richmond", "Rockland",
    "St. Lawrence", "St Lawrence", "Saratoga", "Schenectady", "Schoharie", "Schuyler",
    "Seneca", "Steuben", "Suffolk", "Sullivan", "Tioga", "Tompkins",
    "Ulster", "Warren", "Washington", "Wayne", "Westchester", "Wyoming", "Yates"
  )
)
crime_ny$County <- as.character(crime_ny$County)
crime_ny_with_fips <- merge(crime_ny, county_fips, by.x = "County", by.y = "Name", all.x = TRUE)
crime_ny_with_fips <- crime_ny_with_fips[crime_ny_with_fips$Agency == 'County Total', ]

crime_ny_with_fips_and_pop <- merge(crime_ny_with_fips, 
                                    pop_ny, by.x = c("FIPS", "Year"), 
                                    by.y = c("FIPS.Code", "Year"), 
                                    all.x = TRUE)

crime_ny_with_fips_and_pop <- crime_ny_with_fips_and_pop[!is.na(crime_ny_with_fips_and_pop$Index.Total), ]
crime_ny_with_fips_and_pop <- crime_ny_with_fips_and_pop[, !(names(crime_ny_with_fips_and_pop) %in% c("Geography", "Program.Type"))]

crime_ny$Year <- as.numeric(crime_ny$Year)
crime_ny_filtered <- crime_ny %>%
  mutate(Year_Period = cut(Year, 
                           breaks = seq(1985, max(Year) + 5, 
                           by = 5), 
                           labels = FALSE),
         Year_Period_Label = paste0(floor((Year - 1985) / 5) * 5 + 1985,
                                    "-",
                                    floor((Year - 1985) / 5) * 5 + 1989)
         )
crime_ny_filtered_county_tot <- crime_ny_filtered[crime_ny_filtered$Agency=='County Total',]

```




```{r}
options(scipen=999)
crime_ny_with_fips_and_pop$crime_pct <- crime_ny_with_fips_and_pop$Index.Total/crime_ny_with_fips_and_pop$Population

tot_yearly <- crime_ny_with_fips_and_pop %>%
  group_by(Year) |>
  summarise(Total_crime = sum(Index.Total)) |>
  ungroup()
tot_yearly <- merge(tot_yearly, pop_ny[pop_ny$Geography == 'New York State', ], by.x = "Year", by.y = "Year", all.x = TRUE)
tot_yearly$pct <- 1000*tot_yearly$Total_crime/tot_yearly$Population

tot_yearly1 <- tot_yearly |> pivot_longer(cols = c('Total_crime', 'pct'),
                           names_to = 'total_or_pct',
                           values_to = 'total_pct_vals')

tot_yearly1$total_or_pct <- factor(tot_yearly1$total_or_pct, levels = c("Total_crime", "pct"))

ggplot(tot_yearly1, aes(x = Year, y = total_pct_vals)) +
  geom_col() +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(title = "Crimes in NY State by Year",
       x = "Year",
       y = "Count") +
  facet_wrap(~total_or_pct, 
             scales = "free_y", 
             ncol = 1,
             labeller = as_labeller(c(pct = "Crimes (per 1000 people)", Total_crime = "Total number of crimes") ) ) +
  ylab(NULL)

```

We observe a dramatic decrease in total crime numbers, especially between 1990 and 2000 in NY State. Even adjusted by population, the crime numbers per 1000 people living in NY State at the time decreases drastically as well. The drop off is even more significant, since while the total number of crimes decreased, the population increased at the same time. The decrease in crime tapers off towards 2010 and then gets another slight boost after 2012. Finally, there is a significant increase in the total crime numbers, as well as the value adjusted by population after 2021. This is without a doubt an outlier in the overall decreasing trend of crime numbers in the prior 30 years, and, therefore, we strongly belive that it can be attested to the socioeconomic ripple effects of COVID-19.

We shall investigate this now a bit more.

## Effect of COVID-19 on Crime in the case of NY State

We have observed that there is an interesting and significant uptick of crime after 2021, which we believe is associated with the effects of COVID-19. This is certainly worth investigating some more. Immediate questions that arise are:

 - Which counties have experienced the worst increase in crime post-COVID, and can we observe geographical cluster associated with it?
 - What types of crimes specifically have increased?

### Impact of COVID-19 on Crimes per County

We first investigate the uptick in crimes by NY State County. As there are 62 Counties in NY State, we first investigate the top 10 counties with the strongest (percentage) increase in crime since 2020. More precisely, we calculate the difference in the crime per population from 2022 to 2020, and select the counties with the largest increase in that number.

```{r}
# impact_of_covid <- crime_ny_with_fips_and_pop
# impact_of_covid$crime_pct <- impact_of_covid$Index.Total/impact_of_covid$Population
# 
# crime_increase <- impact_of_covid[impact_of_covid$Year > 2020, ] %>%
#   group_by(County) %>%
#   summarize(increase = last(crime_pct) - first(crime_pct)) %>%
#   filter(!is.na(increase))
# 
# top_counties <- crime_increase %>% top_n(62, wt = increase)
# 
# selected_data <- impact_of_covid %>%
#   filter(County %in% top_counties$County)
# 
# county_order <- names(sort(tapply(selected_data$crime_pct, selected_data$County, max), decreasing = TRUE))
# selected_data$County <- factor(selected_data$County, levels = county_order)
# 
# my_palette <- viridis_pal()(length(unique(selected_data$County)))
# 
# ggplot(selected_data, aes(x = Year, y = crime_pct, color = County)) +
#   geom_line() +
#   scale_color_manual(values = my_palette) +
#   labs(title = "Crime/population per Year for Counties with worst increase post-covid",
#        x = "Year",
#        y = "Crime/population") +
#   theme_minimal()

impact_of_covid <- crime_ny_with_fips_and_pop
impact_of_covid$crime_pct <- impact_of_covid$Index.Total/impact_of_covid$Population
impact_of_covid <- impact_of_covid[impact_of_covid$Year > 2015, ]

crime_increase <- impact_of_covid[impact_of_covid$Year >= 2020, ] %>%
  group_by(County) %>%
  summarize(increase = last(crime_pct) - first(crime_pct)) %>%
  filter(!is.na(increase))

top_counties <- crime_increase %>% top_n(10, wt = increase)

selected_data <- impact_of_covid %>%
  filter(County %in% top_counties$County)

county_order <- names(sort(tapply(selected_data$crime_pct, selected_data$County, max), decreasing = TRUE))
selected_data$County <- factor(selected_data$County, levels = county_order)

my_palette <- brewer.pal(n = length(unique(selected_data$County)), name = "Set3")

ggplot(selected_data, aes(x = Year, y = 1000*crime_pct, color = County)) +
  geom_line(size = 0.9) +
  scale_color_manual(values = my_palette) +
  labs(title = "Crime (per 1000 population) for Counties with worst increase after 2020",
       x = "Year",
       y = "Crime (per 1000 people)") +
  theme_minimal()

```

We see that the NY City area dominates and experienced the largest increase. In the plot we provide the values since 2016, in order to contrast the uptick with the previous trend.

We should be slightly careful here, and remark that these numbers are based on the estimated population sizes for each County. However, we believe that the effects of the COVID-19 pandemic also affected these estimates. For instance, the population in NY City decreased quite drastically during the pandemic and by 2022 has not recovered to its previous values, see for instance this [NY  Times article](https://www.nytimes.com/2022/06/28/nyregion/wealthy-pandemic-nyc.html). However, this would actually suggest that the crime numbers per 1000 population are actually more likely than not an underestimate, and the uptick in crime was even more drastic. For other counties, this is less clear, as it is likely that many NY City workers moved to countie neighboring NY City, and therefore these number might be an overestimate.

It is interesting to contrast the counties with the largest increase from 2020 to 2022 to the ones with the least increase (or even decrease).

```{r}
top_counties <- crime_increase %>% top_n(5, wt = increase)
bottom_counties <- crime_increase |> top_n(5, wt = -increase)
selected_data <- impact_of_covid |>
  filter((County %in% bottom_counties$County) | County %in% top_counties$County) 
county_order <- names(sort(tapply(selected_data$crime_pct, selected_data$County, max), decreasing = TRUE))

county_order <- names(sort(tapply(selected_data$crime_pct, selected_data$County, max), decreasing = TRUE))

selected_data$County <- factor(selected_data$County, levels = county_order)
my_discrete_palette <- viridis_pal(option = "D")(length(unique(selected_data$County)))

ggplot(selected_data, aes(x = Year, y = 1000*crime_pct, color = County)) +
  geom_line(size = 0.9) +
  scale_color_manual(values = my_discrete_palette) +
  labs(title = "Crime (per 1000 population) for Counties with least/worst increase after 2020",
       x = "Year",
       y = "Crime (per 1000 people)") +
  theme_minimal()

```

We can observe the smaller counties such as Fulton, Seneca and Sullivan did not seem to be affected by any increase in crime rates after covid, but rather their crime rates relatively judiciously continues the trend from pre-COVID. All these counties are far away from big population concentrations and seem to be more rural. As mentioned in the introduction, the power of this NY State dataset is that it represents very different parts and styles of living and, therefore, allows for better contrasts and potentially more interesting questions about causation.

Finally, let us get a more comprehensive geographic look over the whole state by comparing the percentage increase/decrease of crimes per population since 2020. So, now, we look at the percentage increase of crime adjusted for population size from 2020 to 2022, i.e. as before, we calculate the differce between the crime/population for 2022 and and 2020, but now divide by the 2020 value, to get a percentage.

```{r, echo=FALSE,results='hide', message=FALSE, warning=FALSE}
#| fig-width: 8
#| fig-height: 8
impact_of_covid <- crime_ny_with_fips_and_pop
impact_of_covid$crime_pct <- impact_of_covid$Index.Total/impact_of_covid$Population

crime_pct_increase <- impact_of_covid[impact_of_covid$Year >= 2020, ] %>%
  group_by(County) %>%
  summarize(increase = 100*(last(crime_pct) - first(crime_pct))/first(crime_pct)) %>%
  filter(!is.na(increase))

ny_state_boundaries <- st_read("../tl_2016_36_cousub/tl_2016_36_cousub.shp")
ny_state_boundaries <- st_transform(ny_state_boundaries, crs = 4326)
ny_state_boundaries$COUNTYFP <- as.character(ny_state_boundaries$COUNTYFP)

impact_of_covid_region <- impact_of_covid %>% select(FIPS, County)
impact_of_covid_region <- impact_of_covid_region[!duplicated(impact_of_covid_region), ]
impact_of_covid_region <- merge(impact_of_covid_region, crime_pct_increase, by.x = "County", by.y = "County")
impact_of_covid_region$FIPS <- as.character(impact_of_covid_region$FIPS)

crime_ny_covid_merged <- merge(ny_state_boundaries, impact_of_covid_region, by.x = "COUNTYFP", by.y = "FIPS")
crime_ny_covid_sf <- st_as_sf(crime_ny_covid_merged, coords = c("Longitude", "Latitude"), crs = 4326)
desired_crs <- 4326

color_scale <- scale_fill_viridis_c(option = "magma", direction = -1)

first <- ggplot(crime_ny_covid_sf, aes(fill = increase)) +
  geom_sf(color = "black") +
  color_scale +
  theme_minimal() +
  labs(#title = "Percentage Increase in Crime/population from 2020 to 2022",
       fill = "Increase (%)")

second <- ggplot(crime_pct_increase, aes(x = reorder(County, increase), y = increase)) +
  geom_bar(stat = "identity", aes(fill = increase)) +
  color_scale +
  theme_minimal() +
  labs(title = "Percentage Increase in Crime/population from 2020 to 2022",
       x = "County",
       y = "Increase (%)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 8))

second <- second + theme(legend.position = "none")

combined_plots <-  second/first + plot_layout(heights = c(1,3))

combined_plots

```

 - Schuyler seems to have a 90% increase since covid:
 - Discuss geography, specifically "outliers" outside of NYC and neighbouring areas.

```{r}
selected_data <- impact_of_covid[impact_of_covid$County == 'Schuyler', ]
selected_data <- selected_data[selected_data$Year > 2015, ]

ggplot(selected_data, aes(x = Year, y = crime_pct, color = County)) +
  geom_line() +
  scale_color_manual(values = my_palette) +
  labs(title = "Crime/population per Year for Counties with least increase post-covid",
       x = "Year",
       y = "Crime/population") +
  theme_minimal()
```


```{r}
# impact_of_covid <- crime_ny_with_fips_and_pop
# impact_of_covid$crime_pct <- impact_of_covid$Index.Total/impact_of_covid$Population
# 
# crime_pct_increase <- impact_of_covid[impact_of_covid$Year >= 2020, ] %>%
#   group_by(County) %>%
#   summarize(increase = (last(crime_pct) - first(crime_pct))) %>%
#   filter(!is.na(increase))

# 
# ny_state_boundaries <- st_read("../tl_2016_36_cousub/tl_2016_36_cousub.shp")
# ny_state_boundaries <- st_transform(ny_state_boundaries, crs = 4326)
# ny_state_boundaries$COUNTYFP <- as.character(ny_state_boundaries$COUNTYFP)
# 
# impact_of_covid_region <- impact_of_covid %>% select(FIPS, County)
# impact_of_covid_region <- impact_of_covid_region[!duplicated(impact_of_covid_region), ]
# impact_of_covid_region <- merge(impact_of_covid_region, crime_pct_increase, by.x = "County", by.y = "County")
# impact_of_covid_region$FIPS <- as.character(impact_of_covid_region$FIPS)
# 
# crime_ny_covid_merged <- merge(ny_state_boundaries, impact_of_covid_region, by.x = "COUNTYFP", by.y = "FIPS")
# 
# crime_ny_covid_sf <- st_as_sf(crime_ny_covid_merged, coords = c("Longitude", "Latitude"), crs = 4326)
# 
# desired_crs <- 4326
# library(viridis)
# 
# ggplot(crime_ny_covid_sf, aes(fill = increase)) +
#   geom_sf(color = "black") +
#   scale_fill_viridis_c(option = "magma", direction = -1) +
#   theme_minimal() +
#   labs(title = "absolute increase 2020 -> 2022",
#        fill = "increase")
```

### Impact of COVID-19 on Crime Types


```{r}

NYC <- crime_ny_with_fips_and_pop[crime_ny_with_fips_and_pop$Region == 'New York City', ]
columns_to_plot <- c("Murder", "Rape", "Robbery", "Aggravated.Assault", "Burglary", "Larceny", "Motor.Vehicle.Theft")
NYC_long <- tidyr::gather(NYC, key = "Variable", value = "Value", columns_to_plot)
NYC_long_summarized <- NYC_long %>%
  group_by(Year, Variable) %>%
  summarise(Sum_Value = sum(Value, na.rm = TRUE),
            Population = sum(Population)) %>%
  ungroup()

non_NYC <- crime_ny_with_fips_and_pop[crime_ny_with_fips_and_pop$Region != 'New York City', ]
columns_to_plot <- c("Murder", "Rape", "Robbery", "Aggravated.Assault", "Burglary", "Larceny", "Motor.Vehicle.Theft")
non_NYC_long <- tidyr::gather(non_NYC, key = "Variable", value = "Value", columns_to_plot)

non_NYC_long_summarized <- non_NYC_long %>%
  group_by(Year, Variable) %>%
  summarise(Sum_Value = sum(Value, na.rm = TRUE),
            Population = sum(Population)) %>%
  ungroup()

combined_NYC <- rbind(
  mutate(NYC_long_summarized, Location = "NYC"),
  mutate(non_NYC_long_summarized, Location = "Non-NYC")
)

combined_NYC_past5 <- combined_NYC[combined_NYC$Year > 2018,]
combined_NYC_past5$pct <- combined_NYC_past5$Sum_Value/combined_NYC_past5$Population

ggplot(combined_NYC_past5, aes(x = Year, y = 1000*pct, fill = Variable)) +
  geom_bar(stat = "identity") +
  labs(title = "Crime Types by Region",
       x = "Year",
       y = "Crime (per 1000 people)") +
  theme_minimal() +
  facet_wrap(~Location, ncol = 1) +
  scale_fill_manual(values = viridis_pal()(7))
```

```{r}

crime_types <- unique(combined_NYC_past5$Variable)

filtered_data <- combined_NYC_past5 %>% 
  filter(Year %in% c(2020, 2022))

percentage_change <- filtered_data %>%
  group_by(Location, Variable) %>%
  summarise(PercentageChange = ((pct[Year == 2022] - pct[Year == 2020]) / pct[Year == 2020]) * 100)

percentage_change <- percentage_change %>%
  arrange(PercentageChange)

ggplot(percentage_change, aes(x = reorder(Variable, PercentageChange), y = PercentageChange, fill = Location)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  labs(title = "Percentage Change in Crime Types (2020-2022)",
       x = "Crime Type",
       y = "Percentage Change") +
  theme_minimal() +
  scale_fill_manual(values = viridis_pal()(length(unique(percentage_change$Location)))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

absolute_change <- filtered_data %>%
  group_by(Location, Variable) %>%
  summarise(PercentageChange = (pct[Year == 2022] - pct[Year == 2020]))

absolute_change <- absolute_change %>%
  arrange(absolute_change)

ggplot(absolute_change, aes(x = reorder(Variable, PercentageChange), y = 1000*PercentageChange, fill = Location)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  labs(title = "Absolute Change in Crime Types (2020-2022)",
       x = "Crime Type",
       y = "Percentage Change") +
  theme_minimal() +
  scale_fill_manual(values = viridis_pal()(length(unique(percentage_change$Location)))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```





## Crime rates (per population size) per counties for 5 year periods


```{r}
combined_data <- crime_ny_filtered_county_tot %>%
  group_by(Year_Period_Label, County) %>%
  summarise(
    Total_Index = sum(Index.Total),
  ) %>%
  ungroup()

top_5_counts <- combined_data %>%
  group_by(Year_Period_Label) %>%
  top_n(5, wt = Total_Index) %>%
  ungroup()

top_5_counts$County <- fct_reorder(top_5_counts$County, 
                                   top_5_counts$Total_Index, 
                                   .desc = TRUE)

top_5_counts <- top_5_counts %>%
  group_by(Year_Period_Label) %>%
  mutate(Rank = -rank(Total_Index))

top_5_counts$County <- fct_reorder(top_5_counts$County, top_5_counts$Rank)


ggplot(top_5_counts, aes(x = County, 
                         y = Total_Index)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Year_Period_Label, 
             scales = "free_x", #"free_x",
             nrow = 5) +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(title = "Index.Total by County",
       x = "County",
       y = "Index.Total")
```

## Crime types and how they are aligned with each other and the Counties


```{r}

crime_ny_filtered_county_tot <- crime_ny_with_fips_and_pop

crime_ny_filtered_county_tot <- crime_ny_filtered_county_tot %>% select(c('County', 'Year', 'Murder', 'Rape', 'Robbery', 'Aggravated.Assault', 'Burglary', 'Larceny', 'Motor.Vehicle.Theft', 'Population'))

crime_ny_filtered_county_tot <- crime_ny_filtered_county_tot %>% 
  group_by(County, Year) %>%
  summarise_each(list(sum))

crime_ny_filtered_county_tot[ , 3:9] <- 1000*crime_ny_filtered_county_tot[, 3:9]/crime_ny_filtered_county_tot$Population

crime_ny_filtered_county_tot_90s <- crime_ny_filtered_county_tot %>%
  filter(Year < 2000) %>%
  group_by(County) %>%
  summarise(across(everything(), sum))
draw_biplot(crime_ny_filtered_county_tot_90s[,c(1,3:9)], project = F)

crime_ny_filtered_county_tot_00s <- crime_ny_filtered_county_tot %>%
  filter((Year >= 2000) & (Year < 2010)) %>%
  group_by(County) %>%
  summarise(across(everything(), sum))
draw_biplot(crime_ny_filtered_county_tot_00s[,c(1,3:9)], project = F)

crime_ny_filtered_county_tot_10s <- crime_ny_filtered_county_tot %>%
  filter((Year >= 2010) & (Year < 2020)) %>%
  group_by(County) %>%
  summarise(across(everything(), sum))
draw_biplot(crime_ny_filtered_county_tot_10s[,c(1,3:9)], project = F)

crime_ny_filtered_county_tot_20s <- crime_ny_filtered_county_tot %>%
  filter((Year >= 2020) & (Year < 2030)) %>%
  group_by(County) %>%
  summarise(across(everything(), sum))
draw_biplot(crime_ny_filtered_county_tot_20s[,c(1,3:9)], project = F)

```

```{r}

crime_ny_filtered_county_tot_2020_to_22 <- crime_ny_with_fips_and_pop[crime_ny_with_fips_and_pop$Year >= 2020,]

crime_ny_filtered_county_tot_2020_to_22_non_ny <- crime_ny_filtered_county_tot_2020_to_22[crime_ny_filtered_county_tot_2020_to_22$Region == 'Non-New York City', ]
crime_ny_filtered_county_tot_2020_to_22_non_ny <- crime_ny_filtered_county_tot_2020_to_22_non_ny %>% select(c('County', 'Murder', 'Rape', 'Robbery', 'Aggravated.Assault', 'Burglary', 'Larceny', 'Motor.Vehicle.Theft', 'Population'))
crime_ny_filtered_county_tot_2020_to_22_non_ny <- crime_ny_filtered_county_tot_2020_to_22_non_ny %>% 
  group_by(County) %>%
  summarise_each(list(sum))

crime_ny_filtered_county_tot_2020_to_22_non_ny[ , 2:8] <- 10000*crime_ny_filtered_county_tot_2020_to_22_non_ny[, 2:8]/crime_ny_filtered_county_tot_2020_to_22_non_ny$Population

draw_biplot(crime_ny_filtered_county_tot_2020_to_22_non_ny[ , 1:8], 'Rape', project = T)
```


```{r}
crime_ny_filtered_county_tot_2020_to_22_ny <- crime_ny_filtered_county_tot_2020_to_22[crime_ny_filtered_county_tot_2020_to_22$Region != 'Non-New York City', ]
crime_ny_filtered_county_tot_2020_to_22_ny <- crime_ny_filtered_county_tot_2020_to_22_ny %>% select(c('County', 'Murder', 'Rape', 'Robbery', 'Aggravated.Assault', 'Burglary', 'Larceny', 'Motor.Vehicle.Theft', 'Population'))
crime_ny_filtered_county_tot_2020_to_22_ny <- crime_ny_filtered_county_tot_2020_to_22_ny %>% 
  group_by(County) %>%
  summarise_each(list(sum))

crime_ny_filtered_county_tot_2020_to_22_ny[ , 2:8] <- 10000*crime_ny_filtered_county_tot_2020_to_22_ny[, 2:8]/crime_ny_filtered_county_tot_2020_to_22_ny$Population

draw_biplot(crime_ny_filtered_county_tot_2020_to_22_ny[ , 1:8], 'Rape', project = T)
```


## Impact of stop-and-frisk on crime statistics under Bloomberg


```{r}
NYC <- crime_ny_with_fips_and_pop[crime_ny_with_fips_and_pop$Region == 'New York City', ]
columns_to_plot <- c("Murder", "Rape", "Robbery", "Aggravated.Assault", "Burglary", "Larceny", "Motor.Vehicle.Theft")
NYC_long <- tidyr::gather(NYC, key = "Variable", value = "Value", columns_to_plot)
NYC_long_summarized <- NYC_long %>%
  group_by(Year, Variable) %>%
  summarise(Sum_Value = sum(Value, na.rm = TRUE),
            Population = sum(Population)) %>%
  ungroup()

# ggplot(NYC, aes(x = Year)) +
#   geom_point(aes(y = Murder), color = "red", linetype = "solid", size = 1) +
#   geom_point(aes(y = Rape), color = "blue", linetype = "solid", size = 1) +
#   geom_point(aes(y = Robbery), color = "green", linetype = "solid", size = 1) +
#   labs(title = "Time Series Plot for Individual Columns in NYC County",
#        x = "Year",
#        y = "Value") +
#   theme_minimal()

ggplot(NYC_long_summarized, aes(x = Year, y = Sum_Value/Population, color = Variable)) +
  geom_line() +
  scale_color_manual(values = my_palette) +
  labs(title = "Crime/population per Year for Counties with least increase post-covid",
       x = "Year",
       y = "Crime/population") +
  theme_minimal()

```

```{r}
non_NYC <- crime_ny_with_fips_and_pop[crime_ny_with_fips_and_pop$Region != 'New York City', ]
columns_to_plot <- c("Murder", "Rape", "Robbery", "Aggravated.Assault", "Burglary", "Larceny", "Motor.Vehicle.Theft")
non_NYC_long <- tidyr::gather(non_NYC, key = "Variable", value = "Value", columns_to_plot)

non_NYC_long_summarized <- non_NYC_long %>%
  group_by(Year, Variable) %>%
  summarise(Sum_Value = sum(Value, na.rm = TRUE),
            Population = sum(Population)) %>%
  ungroup()

# ggplot(NYC, aes(x = Year)) +
#   geom_point(aes(y = Murder), color = "red", linetype = "solid", size = 1) +
#   geom_point(aes(y = Rape), color = "blue", linetype = "solid", size = 1) +
#   geom_point(aes(y = Robbery), color = "green", linetype = "solid", size = 1) +
#   labs(title = "Time Series Plot for Individual Columns in NYC County",
#        x = "Year",
#        y = "Value") +
#   theme_minimal()
# ggplot(non_NYC_long_summarized, aes(x = Year, y = Sum_Value/Population, color = Variable)) +
#   geom_line() +
#   scale_color_manual(values = my_palette) +
#   labs(title = "Crime/population per Year for Counties with least increase post-covid",
#        x = "Year",
#        y = "Crime/population") +
#   theme_minimal()

combined_NYC <- rbind(
  mutate(NYC_long_summarized, Location = "NYC"),
  mutate(non_NYC_long_summarized, Location = "Non-NYC")
)

ggplot(combined_NYC, 
       aes(x = Year, 
           y = Sum_Value/Population, 
           color = Location, 
           group = Location)) +
  geom_line() +
  labs(title = "NYC vs Non-NYC",
       x = "Year",
       y = "Crime/population") +
  scale_color_manual(values = c("NYC" = "blue", "Non-NYC" = "red")) +
  theme_minimal() +
  facet_wrap(~Variable, scales = "free_y")
```

```{r}

combined_NYC_bloomb <- combined_NYC[(combined_NYC$Year > 1999) & (combined_NYC$Year < 2015), ]

ggplot(combined_NYC_bloomb, 
       aes(x = Year, 
           y = Sum_Value/Population, 
           color = Location, 
           group = Location)) +
  geom_line() +
  labs(title = "NYC vs Non-NYC",
       x = "Year",
       y = "Crime/population") +
  scale_color_manual(values = c("NYC" = "blue", 
                                "Non-NYC" = "red")) +
  theme_minimal() +
  facet_wrap(~Variable, scales = "free_y")
```

During 2002 - 2012, NYC imposed stop-and-frisk, we compare NYC crime reports (for 7 major crime stats) vs non-NYC. If the stop and frisk had any effect, we expect NYC crime stats to decrease stronger than non-NYC. Logic: stop and frisk -> "create more safety" -> less crime overall. 

There are various flaws with our analysis: Do not consider other effects, etc.

To compare set starting point the same:

```{r}
combined_NYC_bloomb <- combined_NYC %>%
  filter(Year > 1999 & Year < 2015) %>%
  group_by(Variable, Location) %>%
  mutate(adjusted_value = Sum_Value/Population - first(Sum_Value/Population))

ggplot(combined_NYC_bloomb, aes(x = Year, y = adjusted_value, color = Location, group = Location)) +
  geom_line() +
  labs(title = "Adjusted NYC vs Non-NYC",
       x = "Year",
       y = "Adjusted") +
  scale_color_manual(values = c("NYC" = "blue", "Non-NYC" = "red")) +
  theme_minimal() +
  facet_wrap(~Variable, scales = "free_y")
```


```{r}

combined_NYC_bloomb <- combined_NYC %>%
  filter(Year > 1980 & Year <=2002) %>%
  group_by(Variable, Location)
combined_NYC_bloomb1 <- combined_NYC_bloomb %>%
  group_by(Year, Location) %>%
  summarise(Sum_Value = sum(Sum_Value, na.rm = TRUE),
            Population = sum(Population)) %>%
  ungroup()
combined_NYC_bloomb1 <- combined_NYC_bloomb1 %>%
  group_by(Location) %>% 
  mutate(adjusted_value = Sum_Value/Population - first(Sum_Value/Population))

combined_NYC_bloomb <- combined_NYC %>%
  filter(Year >= 2002 & Year <=2012) %>%
  group_by(Variable, Location)
combined_NYC_bloomb2 <- combined_NYC_bloomb %>%
  group_by(Year, Location) %>%
  summarise(Sum_Value = sum(Sum_Value, na.rm = TRUE),
            Population = sum(Population)) %>%
  ungroup()
combined_NYC_bloomb2 <- combined_NYC_bloomb2 %>%
  group_by(Location) %>% 
  mutate(adjusted_value = Sum_Value/Population - first(Sum_Value/Population))

combined_NYC_bloomb <- combined_NYC %>%
  filter(Year >= 2012 & Year <=2042) %>%
  group_by(Variable, Location)
combined_NYC_bloomb3 <- combined_NYC_bloomb %>%
  group_by(Year, Location) %>%
  summarise(Sum_Value = sum(Sum_Value, na.rm = TRUE),
            Population = sum(Population)) %>%
  ungroup()
combined_NYC_bloomb3 <- combined_NYC_bloomb3 %>%
  group_by(Location) %>% 
  mutate(adjusted_value = Sum_Value/Population - first(Sum_Value/Population))

ggplot(combined_NYC_bloomb1, aes(x = Year, y = adjusted_value, color = Location, group = Location)) +
  geom_line() +
  labs(title = "NYC vs Non-NYC",
       x = "Year",
       y = "Crime/population") +
  scale_color_manual(values = c("NYC" = "blue", "Non-NYC" = "red")) +
  theme_minimal()

ggplot(combined_NYC_bloomb2, aes(x = Year, y = adjusted_value, color = Location, group = Location)) +
  geom_line() +
  labs(title = "NYC vs Non-NYC",
       x = "Year",
       y = "Crime/population") +
  scale_color_manual(values = c("NYC" = "blue", "Non-NYC" = "red")) +
  theme_minimal()

ggplot(combined_NYC_bloomb3, aes(x = Year, y = adjusted_value, color = Location, group = Location)) +
  geom_line() +
  labs(title = "NYC vs Non-NYC",
       x = "Year",
       y = "Crime/population") +
  scale_color_manual(values = c("NYC" = "blue", "Non-NYC" = "red")) +
  theme_minimal()
```


```{r}


ggplot(combined_NYC, aes(x=Year, y=Sum_Value, fill=Variable)) + 
    geom_area()+
  labs(title = "Stacked Area Plot of Crime Types",
       x = "Year",
       y = "Crime")+
  theme_minimal()+
  facet_wrap(~Location, ncol = 1)

```


<!-- 
https://www.nyclu.org/en/stop-and-frisk-data
-->

